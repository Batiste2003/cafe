services:
  # ===========================================
  # Backend - PHP-FPM with Laravel and SQLite
  # ===========================================
  backend:
    build:
      context: ./smart-cafe-back
      dockerfile: Dockerfile
    container_name: smart-cafe-backend
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      # Mount source code for hot-reloading
      - ./smart-cafe-back:/var/www/html
      # Persist vendor directory (improves performance)
      - backend_vendor:/var/www/html/vendor
      # Mount PHP configuration
      - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
    networks:
      - smart-cafe-network

  # ===========================================
  # Nginx - Reverse proxy for Laravel API
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: smart-cafe-nginx
    restart: unless-stopped
    ports:
      - "8000:80"
    volumes:
      # Mount Laravel public directory
      - ./smart-cafe-back:/var/www/html
      # Mount Nginx configuration
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
    networks:
      - smart-cafe-network

  # ===========================================
  # Frontend - Vue.js with Vite
  # ===========================================
  frontend:
    build:
      context: ./smart-cafe-front
      dockerfile: Dockerfile
    container_name: smart-cafe-frontend
    restart: unless-stopped
    ports:
      - "5173:5173"
    volumes:
      # Mount source code for hot-reloading
      - ./smart-cafe-front:/app
      # Persist node_modules (improves performance)
      - frontend_node_modules:/app/node_modules
    environment:
      - VITE_API_BACKEND_URL=http://localhost:8000
    depends_on:
      - nginx
    networks:
      - smart-cafe-network

  # ===========================================
  # Mobile - Expo React Native (optional)
  # ===========================================
  mobile:
    build:
      context: ./smart-cafe-app
      dockerfile: Dockerfile
    container_name: smart-cafe-mobile
    restart: unless-stopped
    ports:
      - "8081:8081"
      - "19000:19000"
      - "19001:19001"
    volumes:
      # Mount source code for hot-reloading
      - ./smart-cafe-app:/app
      # Persist node_modules (improves performance)
      - mobile_node_modules:/app/node_modules
    environment:
      - EXPO_PUBLIC_API_URL=http://localhost:8000/api
      - EXPO_DEVTOOLS_LISTEN_ADDRESS=0.0.0.0
      - REACT_NATIVE_PACKAGER_HOSTNAME=0.0.0.0
    depends_on:
      - nginx
    profiles:
      - mobile
    networks:
      - smart-cafe-network

# ===========================================
# Networks
# ===========================================
networks:
  smart-cafe-network:
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  backend_vendor:
  frontend_node_modules:
  mobile_node_modules:
